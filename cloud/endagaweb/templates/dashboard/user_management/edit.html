{% extends "dashboard/layout.html" %}
{% comment %}
Copyright (c) 2016-present, Facebook, Inc.
All rights reserved.

This source code is licensed under the BSD-style license found in the
LICENSE file in the root directory of this source tree. An additional grant
of patent rights can be found in the PATENTS file in the same directory.
{% endcomment %}
{% load guardian_tags %}
{% load account socialaccount %}
{% block pagestyle %}
<style>

    .form-check-label {
        font-weight: unset;
    }
    .msg {
        display: none;
    }
    .error {
        color: #a94442;
    }
    .success {
        color: green;
    }
    .exists {
        display:none;
        color:#a94442;
    }
    .no_perm_error {
        color: #a94442;
    }


</style>
{% endblock %}

{% block headerclass %}

<body id="add_user">
<header class="navbar navbar-inverse normal" role="banner">
    {% endblock %}
    {% block content %}
    <div class="row">
        <div class="col-xs-12 col-sm-12 page-header">
            <h4 class="page-title">
                <i class='fa fa-user'></i>
                Edit
            </h4>
        </div>
    </div>

    <div class='row'>
        {% include "dashboard/user_management/nav.html" with active_tab='add'%}
        <div class="container col-sm-10">
            {% for message in messages %}
            <div class="message alert alert-{{message.tags}}">
                <a href="#" class="close" data-dismiss="alert">&times;</a>
                {{message}}
            </div>
            {% endfor %}
            <form id="user_form" name="user_form" method="POST"
                      data-toggle="validator" onsubmit="return updateUser();"> {% csrf_token %}
                    <!--Update User-->
                    <!--Role-->
                    <div class="form-group row" data-toggle="tooltip" title="Select the user role" required>
                        <div class="col-xs-5">
                            <label>Role <span class="aseriskField">*</span></label>
                            <div class="input-group col-xs-8">
                                <div class="input-group-addon">
                                    <i class="glyphicon glyphicon-user"></i>
                                </div>
                                <select name="role" id="role" class="form-control" required>
                                    {% for values in roles %}
                                    {% if user_role == values %}
                                    <option value="{{ values }}" selected="selected">{{ values }}</option>
                                    {% else %}
                                    <option value="{{ values }}">{{ values }}</option>
                                    {% endif %}
                                    {% endfor %}
                                </select>

                            </div>
                        </div>
                    </div><!--Role Ends-->

                    <!--Email-->
                    <div class="form-group row">
                        <div class="col-xs-5" data-toggle="tooltip" data-placement="left"
                             title="User's email">
                            <label class="col-3 col-form-label">Email</label>
                            <div class="input-group col-xs-8">
                                <div class="input-group-addon">
                                    <i class="glyphicon glyphicon-envelope"></i>
                                </div>
                                <input type="hidden" name="valid_email" id="valid_email" value={{ email }} />
                                <input class="form-control" type="text"
                                       id="update-email" value={{ email }} name="email" placeholder="abc@yourdomain.com" disabled/>
                            </div>
                        </div>
                    </div><!--Email Ends-->

                    <!--Network-->
                    <div class="form-group row">
                        <div class="col-xs-5" data-toggle="tooltip" data-placement="left"
                             title="Current Network">
                            <label for="network" class="col-3 col-form-label">Current Network:</label>
                            <div class="input-group col-xs-8">
                                <div class="input-group-addon">
                                    <i class="glyphicon glyphicon-signal"></i>
                                </div>
                                <input class="form-control" type="text" id="network" value={{ network.name }} name="network" placeholder="network" disabled/>
                            </div>
                        </div>
                    </div><!-- Network Ends -->

                    <!--Permissions-->
                    <div class="form-group column">
                        <div>
                            <div class="row">
                                <div class="col-xs-5">
                                    <label><i class="glyphicon glyphicon-list-alt"></i> Avaliable Permissions on {{ network.name }}</label>
                                    <select name="available_permissions" id="permissions_left" class="form-control"
                                            size="10"
                                            multiple="multiple" data-toggle="tooltip"
                                            title="Add/Remove the permissions for the user">
                                        {% for entry in permissions %}
                                        <option value="{{ entry.id }}">{{ entry.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-xs-2">
                                    <div>&nbsp;</div>
                                    <div>&nbsp;</div>
                                    <button type="button" id="lstview_rightAll" class="btn btn-default btn-block"><i
                                            class="glyphicon glyphicon-forward"></i></button>
                                    <button type="button" id="lstview_rightSelected"
                                            class="btn btn-default btn-block"><i
                                            class="glyphicon glyphicon-chevron-right"></i></button>
                                    <button type="button" id="lstview_leftSelected"
                                            class="btn btn-default btn-block"><i
                                            class="glyphicon glyphicon-chevron-left"></i></button>
                                    <button type="button" id="lstview_leftAll" class="btn btn-default btn-block"><i
                                            class="glyphicon glyphicon-backward"></i></button>
                                </div>
                                <div class="col-xs-5">
                                    <label><i class="glyphicon glyphicon-list-alt"></i> User Permissions on {{ network.name }}</label>
                                    <select name="existing_permissions" id="permissions_right" class="form-control"
                                            size="10"
                                            multiple="multiple" data-toggle="tooltip"
                                            title="Added/Existing permissions">
                                        {% for entry in user_permissions %}
                                        <option value="{{ entry.id }}">{{ entry.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <span class="msg no_perm_error">Please assign atleast one permission.</span>
                                </div>
                            </div>
                        </div>
                    </div><!-- Permission Ends -->
                    <div class="row">&nbsp;</div>
                    <div>
                        <input type="submit" id="update" class="btn btn-primary" value="Update" />
                        <a class="btn btn-primary" href="/dashboard/user/management">Cancel</a>
                    </div>

                </form>
                    <!--Update User Ends-->
        </div>
    </div>
    <div class="row">&nbsp;</div>
    <div class="row">&nbsp;</div>
    <div class="row">&nbsp;</div>
</header>
{% endblock %}
{% block js %}
<!--<script src="/static/js/dashboard/validator.js"></script>-->
<script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.11.1/jquery.validate.min.js"></script>
<script>

    function moveItems(origin, dest) {
        $(origin).find(':selected').appendTo(dest);
        $('.no_perm_error').hide();
        $('.no_perm_error').parent().removeClass('has-warning');
    }

    function moveAllItems(origin, dest) {
        $(origin).children().appendTo(dest);
        $('.no_perm_error').hide();
        $('.no_perm_error').parent().removeClass('has-warning');
    }

    $(document).ready(function() {
        $("#permissions_row tr:odd").css("background", "#DAE4F0");
        $("#permissions_row tr:even").css("background", "#eee");

        $('#lstview_rightSelected').click(function () {
            moveItems('#permissions_left', '#permissions_right');
        });

        $('#lstview_leftSelected').on('click', function () {
            moveItems('#permissions_right', '#permissions_left');
        });

        $('#lstview_leftAll').on('click', function () {
            moveAllItems('#permissions_right', '#permissions_left');
        });

        $('#lstview_rightAll').on('click', function () {
            moveAllItems('#permissions_left', '#permissions_right');
        });

  });
    //$('#submit').click(function(){
    function updateUser() {
        var permissions = [];
        $.each($('#permissions_right option'), function(key, val) {
            permissions.push($(val).val());
        });

        $.ajax({
            type: 'POST',
            beforeSend: function(xhr) {
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            },
            data:{
                role: $('#role').val(),
                email: $('#update-email').val(),
                permissions: permissions.join(",")
            }
        }).done(function(response) {
            window.location.href = '/dashboard/user/management/update';
        }).success(function(){
         // alkdflkjshdkj
         window.location.reload();
         //location.reload();
        });
        return false;
    }
</script>
{% endblock %}
