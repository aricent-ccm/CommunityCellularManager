{% extends "dashboard/layout.html" %}
{% comment %}
Copyright (c) 2016-present, Facebook, Inc.
All rights reserved.

This source code is licensed under the BSD-style license found in the
LICENSE file in the root directory of this source tree. An additional grant
of patent rights can be found in the PATENTS file in the same directory.
{% endcomment %}
{% load apptags %}
{% load humanize %}
{% load crispy_forms_tags %}


{% block pagestyle %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />

<style>
  #map {
    height: 400px;
  }
</style>
{% endblock %}


{% block title %}
{% if tower.nickname %}
{% tmpl_const "SITENAME" %} | {{ tower.nickname }}
{% else %}
{% tmpl_const "SITENAME" %} | tower {{ tower.uuid }}
{% endif %}
{% endblock %}


{% block content %}
{% include "dashboard/tower_detail/header.html" with tower=tower %}

<div class = 'row'>
  {% include "dashboard/tower_detail/nav.html" with uuid=tower.uuid active_tab='info'%}

  <div class='content col-xs-12 col-sm-10 col-md-4'>
    {% for message in messages %}
    <div class="message alert alert-{{ message.tags }}">
        <a href="#" class="close" data-dismiss="alert">&times;</a>
        {{ message }}
    </div>
    {% endfor %}
    <p>
      <strong>Status</strong>:
      {% if tower.status == 'active' %}
        <span class='label label-success'>{{ tower.get_status_display }}</span>
      {% elif tower.status == 'inactive' %}
        <span class='label label-danger'>{{ tower.get_status_display }}</span>
      {% else %}
        <span class='label label-default'>{{ tower.get_status_display }}</span>
      {% endif %}
    </p>
    <p><strong>Last Sync</strong>: {{ tower.last_active|naturaltime }}</p>
    <p><strong>Uptime</strong>:
      {% if uptime %}
      {{ uptime }}
      {% else %}
      <i>unknown</i>
      {% endif %}
    </p>
    <p><strong>Lat / Lon</strong>: {{ tower.latitude }}, {{ tower.longitude }}</p>
    <p><strong>Updates</strong>: {{ tower.max_seqno }}</p>
    <p><strong>Software Version</strong>:
      {% if tower_endaga_version %}
      {{ tower_endaga_version }}
      {% else %}
      <i>unknown</i>
      {% endif %}
    </p>
  </div>

  <div class='col-xs-12 col-sm-offset-2 col-sm-10 col-md-offset-0 col-md-6'>
    <div id='map'></div>
  </div>
</div>
{% include "dashboard/subscriber_detail/broadcast.html" with target='tower' uuid=tower.uuid %}
{% endblock %}


{% block js %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
  <script>
    $(function() {
      var map = L.map('map').setView([{{ tower.latitude }}, {{ tower.longitude }}], 13);
      L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      L.control.scale().addTo(map);
      var iconColorStatusMap = {
        'no-data': 'gray',
        'inactive': 'red',
        'active': 'green',
      }
      var markerIcon = L.AwesomeMarkers.icon({
        icon: 'signal',
        prefix: 'fa',
        markerColor: iconColorStatusMap['{{ tower.status }}'],
      });
      var marker = L.marker([{{ tower.latitude }}, {{ tower.longitude }}], {icon: markerIcon}).addTo(map);
    });
  </script>


<script type="text/javascript">
function setloading() {
  var $btn = $('#submit').button().button('loading');
}

$(document).ready(function() {

  $('input[type=radio][name="send_to"]').change(function() {
    console.log("this.value =  ", this.value );
    if (this.value == 'network') {
        $('#network_row').show();
        $('#tower_row').show();
        $('#imsi_row').hide();
    } else if (this.value == 'tower') {
        $('#network_row').hide();
        $('#tower_row').show();
        $('#imsi_row').hide();
    } else if (this.value == 'imsi') {
        $('#network_row').hide();
        $('#tower_row').hide();
        $('#imsi_row').show();
    } else {
        $('#network_row').show();
        $('#tower_row').show();
    }
  });
  $('#broadcast-modal').on('shown.bs.modal', function() {
    $('#network_row').hide();
    $('#tower_row').show();
    $('#imsi_row').hide();
  });

  $('#broadcast_submit').click(function() {
    //var $btn = $('#broadcast_submit').button().button('loading');
    var data = {
      sendto: $('input[type=radio][name="send_to"]:checked').val(),
      network_id: $('#network_id').val(),
      tower_id: $('#bts_id').val(),
      imsi: $('#imsi').val(),
      message: $('#message').val(),
      csrfmiddlewaretoken: '{{ csrf_token }}',
    };
    $.post('/dashboard/broadcast', data, function(response) {
      if (response['status'] == 'ok') {
        // Show that it was successful and then reload the page.
        // Clear out any old messages and show the div again.
        $('#messages-container').html();
        $('#messages-container').css('opacity', 1);
        var message = 'Tower added successfully.';
        var html = '<div class="alert alert-success">' + message + '</div>';
        $('#messages-container').html(html);
        setTimeout(function() {
          location.reload();
        }, 800);
      } else {
        // Show the messages that were sent back.
        // Clear out any old messages and show the div again.
        $('#messages-container').html();
        $('#messages-container').css('opacity', 1);
        var html = '';
        response['messages'].map(function(message) {
          html += '<div class="alert alert-danger">' + message + '</div>';
        });
        $('#messages-container').html(html);
        setTimeout(function() {
          $('#messages-container').fadeTo(500, 0);
        }, 4000);
      }
    });


  });
});
</script>
{% endblock %}