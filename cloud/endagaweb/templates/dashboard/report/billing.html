{% extends "dashboard/layout.html" %}
{% comment %}
Copyright (c) 2016-present, Facebook, Inc.
All rights reserved.

This source code is licensed under the BSD-style license found in the
LICENSE file in the root directory of this source tree. An additional grant
of patent rights can be found in the PATENTS file in the same directory.
{% endcomment %}
{% load apptags %}
{% load humanize %}
{% load crispy_forms_tags %}


{% block title %}
    {% tmpl_const "SITENAME" %} | Report
    {% if report_summary  %}
        | "{{ report_summary }}"
    {% endif %}
{% endblock %}

{% block pagestyle %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.1.13-beta/nv.d3.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.14.30/css/bootstrap-datetimepicker.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.15/css/jquery.dataTables.min.css" type="text/css"/>

<style type="text/css">
  .nv-label, .nv-legend-text {
    text-transform: capitalize;
  }
  td {
    text-align: center;
  }
</style>

{% endblock %}

{% block content %}
    {% include "dashboard/report/header.html" with header='Billing'  %}

    <div class='row'>
        {% include "dashboard/report/nav.html" with active_tab='billing_reports' %}

        <div class='content col-xs-12 col-sm-10 col-md-10'>

            {% include "dashboard/report/filter.html" with action_url='/dashboard/reports/billing' %}

            {% if network_has_activity %}
            <div class="row">
                <div id='call-usage-chart'></div>
                <div id='sms-usage-chart'></div>
                <div id='call-sms-usage-chart'></div>
                <div id='load-transfer-usage-chart'></div>
                <div id='add-money-usage-chart'></div>
            </div>
            <div class="row">
              <div id='billing-waterfall-summary-chart'></div>
            </div>
            <div class="row">
              <div id="loader_summary">
                {% include "dashboard/report/waterfall.html" with title="Waterfall - Loader" %} 
              </div>
            </div>
            <div class="row">&nbsp;</div>
            <div class="row">
              <div id="loader_transaction">
                {% include "dashboard/report/waterfall.html" with title="Waterfall - Loader Transactions" %} 
              </div>
            </div>

            {% else %}
                <p>There is no network activity to display.</p>
            {% endif %}

        </div> <!-- /.col-md-4 -->
    </div>
{% endblock %}

{% block js %}
{% if network_has_activity %}
<script>
  $(function() {
    setTimeout(function() {
      $('.timezone-notice').fadeIn(500);
    }, 800);
  });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.12.2/react.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.12.2/JSXTransformer.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.1.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.1.13-beta/nv.d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.14.30/js/bootstrap-datetimepicker.min.js"></script>
<script src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>

<script type="text/jsx" src="/static/js/dashboard/report-chart-components.js"></script>
<script type="text/jsx">
  var currentTimeEpoch = {{ current_time_epoch }};
  var timezoneOffset = {{ timezone_offset }};

{% if 'Call Billing' in reports %}
  React.render(
    <TimeseriesChartWithButtonsAndDatePickers
      title='Call Billing Report'
      chartID='call-chart'
      statTypes='local_call,outside_call'
      level='{{ level }}'
      levelID='{{ level_id }}'
      aggregation='transaction_sum'
      yAxisLabel='charges of calls'
      currentTimeEpoch={currentTimeEpoch}
      timezoneOffset={timezoneOffset}
      chartType='pie-chart'
      tooltipUnits='s of'
    />,
    document.getElementById('call-usage-chart')
  );
{% endif %}
{% if 'SMS Billing' in reports %}
  React.render(
    <TimeseriesChartWithButtonsAndDatePickers
      title='SMS Billing Report'
      chartID='sms-chart'
      statTypes='local_sms,outside_sms'
      level='{{ level }}'
      levelID='{{ level_id }}'
      aggregation='transaction_sum'
      yAxisLabel='charges of sms'
      currentTimeEpoch={currentTimeEpoch}
      timezoneOffset={timezoneOffset}
      chartType='pie-chart'
      tooltipUnits='s of'
    />,
    document.getElementById('sms-usage-chart')
  );
  {% endif %}
  {% if 'Call and SMS Billing' in reports %}
  React.render(
    <TimeseriesChartWithButtonsAndDatePickers
      title='Call and SMS Billing Report'
      chartID='call-sms-chart'
      statTypes='local_call,outside_call,local_sms,outside_sms'
      level='{{ level }}'
      levelID='{{ level_id }}'
      aggregation='transaction_sum'
      yAxisLabel='call and sms charges'
      currentTimeEpoch={currentTimeEpoch}
      timezoneOffset={timezoneOffset}
      chartType='pie-chart'
      tooltipUnits='s of'
    />,
    document.getElementById('call-sms-usage-chart')
  );
  {% endif %}
  {% if 'Retailer Load Transfer' in reports %}
  React.render(
    <TimeseriesChartWithButtonsAndDatePickers
      title='Retailer Load Transfer Report'
      chartID='load-transfer-chart'
      statTypes='transfer'
      level='{{ level }}'
      levelID='{{ level_id }}'
      aggregation='transaction_sum'
      yAxisLabel='Load Transfer'
      currentTimeEpoch={currentTimeEpoch}
      timezoneOffset={timezoneOffset}
      chartType='bar-chart'
      tooltipUnits='s of'
    />,
    document.getElementById('load-transfer-usage-chart')
  );
  {% endif %}
  {% if 'Retailer Recharge' in reports %}
  React.render(
    <TimeseriesChartWithButtonsAndDatePickers
      title='Retailer Recharge Report'
      chartID='add-money-chart'
      statTypes='add-money'
      level='{{ level }}'
      levelID='{{ level_id }}'
      aggregation='transaction_sum'
      yAxisLabel='Add Money'
      currentTimeEpoch={currentTimeEpoch}
      timezoneOffset={timezoneOffset}
      chartType='bar-chart'
      tooltipUnits='s of'
    />,
    document.getElementById('add-money-usage-chart')
  );
  {% endif %}
  {% if 'Activation' in reports %}
  React.render(
    <TimeseriesChartWithButtonsAndDatePickers
      title='Waterfall Activation Summary'
      chartID='summary-chart'
      statTypes='provisioned'
      level='{{ level }}'
      levelID='{{ level_id }}'
      aggregation='valid_through'
      yAxisLabel='numbers of activation'
      currentTimeEpoch={currentTimeEpoch}
      timezoneOffset={timezoneOffset}
      tooltipUnits='s of'
      chartType='line-chart'
    />,
    document.getElementById('billing-waterfall-summary-chart')
  );
  {% endif %}

</script>
<script type="text/javascript">
function setloading() {
  var $btn = $('#submit').button().button('loading');
  var $btn = $('.submit').button().button('loading');
}
function renderTable(tableId, aggregation) {

  $('#'+tableId+' .from_month').datetimepicker({
    viewMode: 'months',
    format: 'MM/YYYY',
    defaultDate:'01/01/2016'
  });

  $('#'+tableId+' .to_month').datetimepicker({
    viewMode: 'months',
    format: 'MM/YYYY',
    defaultDate:'01/06/2017'
  });

  $('#'+tableId+' .submit').click(function(){
    console.log("Filter called for ", tableId);
  });

  $('#'+tableId+' .submit').click(function(){
    var from_date = moment.utc($('#'+tableId+' .from_month').val(), 'MM/YYYY').unix();
    var to_month = moment.utc($('#'+tableId+' .to_month').val(), 'MM/YYYY').unix();

    var queryParams = {
      'start-time-epoch': from_date,
      'end-time-epoch': to_month,
      'stat-types': aggregation,
      'interval': 'months',
      'level-id':{{ level_id }},
      'aggregation': aggregation
    };
    var endpoint = '/api/v1/stats/network';
    $.get(endpoint, queryParams, function(data) {
      console.log(data);
      var tableHeader = data['results'][0]['values']['header'];
      var tableData = data['results'][0]['values']['data'];

      $('#'+tableId+' .table').DataTable({
        data: tableData,
        paging:   false,
        ordering: false,
        info:     false,
        searching: false,
        autoWidth: true,
        scrollY: 500,
        //scrollX: 'auto',
        destroy: true,
        columns: tableHeader,
        scrollX: true,
        // fixedColumns: true
        // fixedColumns: {leftColumns: 2}
      });
    });
    console.log("Date = ", from_date, to_month);

  });

}
$(document).ready(function() {
  
  renderTable('loader_summary', 'loader');
  //renderTable('loader_transaction', 'reload_rate');
  //renderTable('loader_transaction', 'reload_amount');
  renderTable('loader_transaction', 'reload_transaction');
  //renderTable('loader_transaction', 'average_frequency');
  
  
});
</script>

{% endif %}

{% endblock %}